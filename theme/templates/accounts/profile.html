{% extends "base.html" %}
{% load custom_tags %}

{% block content %}
<div class="text-white min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

    <!-- CARD -->
    <div class=" p-6 sm:p-10 border-b-2 border-gray-600">

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-10 items-start">

        <!-- AVATAR -->
        <div class="relative w-40 h-40 sm:w-72 sm:h-72 mx-auto md:mx-0 group cursor-pointer">
          <button id="avatarBtn"
                  class="w-full h-full rounded-full overflow-hidden border-4 border-gray-600 relative">

            {% if user.avatar %}
              <img src="{{ user.avatar.url }}" alt="Avatar"
                   class="w-full h-full object-cover">
            {% else %}
              <span class="text-4xl sm:text-5xl font-bold flex items-center justify-center w-full h-full">
                {{ user.first_name|default:user.email|slice:":1" }}{{ user.last_name|slice:":1" }}
              </span>
            {% endif %}

            <div
              class="absolute inset-0 flex items-center justify-center
                     bg-black bg-opacity-40 opacity-0
                     group-hover:opacity-100 transition">
              <span class="material-symbols-outlined text-white text-4xl">
                edit
              </span>
            </div>
          </button>

          <!-- AVATAR FORM -->
          <form id="avatarForm"
                method="post"
                enctype="multipart/form-data"
                class="absolute inset-0 hidden flex flex-col items-center justify-center
                       bg-gray-900 bg-opacity-90 rounded-full p-4">
            {% csrf_token %}

            <label for="avatarInput" class="cursor-pointer text-center">
              <div class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded mb-3">
                Browse file
              </div>
              <input id="avatarInput" type="file" name="avatar"
                     accept="image/*" class="hidden">
            </label>

            <button type="submit"
                    class="bg-green-600 hover:bg-green-700 px-4 py-1 rounded text-sm mb-2">
              Upload
            </button>

            <button type="button" id="avatarCancelBtn"
                    class="text-gray-300 hover:text-white text-sm">
              Cancel
            </button>
          </form>
        </div>

        <div class="md:col-span-2 space-y-5 w-full">

          {% for label, field in editable_fields %}
          <div id="field-{{ field }}"
            class="group relative
                    bg-gray-800/70 rounded-2xl px-5 py-4
                    flex flex-col sm:flex-row
                    sm:items-center sm:justify-between gap-3

                    transition-all duration-300 ease-out
                    hover:shadow-2xl hover:shadow-gray-500/20
                    hover:bg-gray-800">

            <p class="text-lg sm:text-xl font-semibold break-all">
              {{ label }}:
              {% if field == 'password' %}
                ********
              {% elif field == 'role' %}
                {{ user.get_role_display }}
              {% else %}
                <span class="field-value">{{ user|attr:field }}</span>
              {% endif %}
            </p>

            {% if field != 'password' %}
              <button
                class="edit-btn bg-blue-600 hover:bg-blue-700
                       px-4 py-1.5 rounded-lg text-sm"
                data-field="{{ field }}">
                Edit
              </button>
            {% endif %}

            {% if field == 'password' %}
            <form method="post"
                  class="edit-form hidden flex flex-col gap-2 w-full sm:w-auto"
                  data-field="password">
              {% csrf_token %}

              {{ password_form.new_password1|add_class:"text-black px-3 py-2 rounded-lg w-full sm:w-64" }}
              {% if password_form.new_password1.errors %}
                <p class="text-red-400 text-sm">
                  {{ password_form.new_password1.errors.0 }}
                </p>
              {% endif %}

              {{ password_form.new_password2|add_class:"text-black px-3 py-2 rounded-lg w-full sm:w-64" }}
              {% if password_form.new_password2.errors %}
                <p class="text-red-400 text-sm">
                  {{ password_form.new_password2.errors.0 }}
                </p>
              {% endif %}

              <div class="flex gap-2">
                <button type="submit"
                        class="bg-green-600 hover:bg-green-700 px-4 py-1.5 rounded-lg text-sm">
                  OK
                </button>
                <button type="button"
                        class="cancel-btn bg-gray-600 hover:bg-gray-700 px-4 py-1.5 rounded-lg text-sm">
                  Cancel
                </button>
              </div>
            </form>

            {% else %}
            <form method="post"
                  class="edit-form hidden flex flex-col sm:flex-row gap-2
                         w-full sm:w-auto"
                  data-field="{{ field }}">
              {% csrf_token %}
              <input type="hidden" name="field" value="{{ field }}">

              {% if field == 'role' %}
                <select name="value"
                        class="text-black px-3 py-2 rounded-lg w-full sm:w-64">
                  {% for key, label in user.ROLE_CHOICES %}
                    <option value="{{ key }}"
                      {% if user.role == key %}selected{% endif %}>
                      {{ label }}
                    </option>
                  {% endfor %}
                </select>
              {% else %}
                <input type="text" name="value"
                       value="{{ user|attr:field }}"
                       class="text-black px-3 py-2 rounded-lg w-full sm:w-64">
              {% endif %}

              <div class="flex gap-2">
                <button type="submit"
                        class="bg-green-600 hover:bg-green-700 px-4 py-1.5 rounded-lg text-sm">
                  OK
                </button>
                <button type="button"
                        class="cancel-btn bg-gray-600 hover:bg-gray-700 px-4 py-1.5 rounded-lg text-sm">
                  Cancel
                </button>
              </div>
            </form>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>

      {% if user.is_teacher %}
        <a href="{% url 'teacher_pricing' %}"
           class="block sm:inline-block mt-10 w-full sm:w-auto text-center
                  text-xl font-semibold bg-green-600 hover:bg-green-700
                  px-6 py-3 rounded-xl">
          Set lesson price
        </a>
      {% endif %}

    </div>
  </div>
</div>

<script>
  const avatarBtn = document.getElementById('avatarBtn');
  const avatarForm = document.getElementById('avatarForm');
  const avatarCancel = document.getElementById('avatarCancelBtn');

  avatarBtn.addEventListener('click', () => {
    avatarForm.classList.toggle('hidden');
  });

  avatarCancel.addEventListener('click', () => {
    avatarForm.classList.add('hidden');
  });

  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const field = btn.dataset.field;
      const wrapper = document.getElementById(`field-${field}`);
      wrapper.querySelector('.edit-form').classList.remove('hidden');
      btn.classList.add('hidden');
      wrapper.querySelector('.field-value')?.classList.add('hidden');
    });
  });

  document.querySelectorAll('.cancel-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const form = btn.closest('.edit-form');
      const field = form.dataset.field;
      const wrapper = document.getElementById(`field-${field}`);
      form.classList.add('hidden');
      wrapper.querySelector('.edit-btn')?.classList.remove('hidden');
      wrapper.querySelector('.field-value')?.classList.remove('hidden');
    });
  });
</script>
{% endblock %}
