{% if user.is_authenticated %}
<!-- Messages Panel -->
<div id="messagesPanel"
     class="fixed right-0 top-24 h-[calc(100vh-13rem)] w-1/6 min-w-[250px] bg-white/0
            overflow-hidden flex flex-col z-40">

    <!-- Conversations -->
    <div class="flex justify-between items-center p-4 border-b border-gray-700/50 ">
        <h3 class="font-semibold text-gray-200 text-xl">Your Conversations</h3>
        <button id="newMsgBtn" class="text-blue-400 hover:text-blue-300 text-base transition underline pr-4">New</button>
    </div>

    <!-- Existing Conversations -->
    <div id="userList" class="flex-1 overflow-y-auto">
        {% for user in users %}
        <div class="user-item flex items-center gap-3 p-3 hover:bg-white/10 cursor-pointer transition rounded-r-lg" data-user-id="{{ user.id }}">
            
            {% if user.profile_image.url %}
            <img src="{{ user.profile_image.url }}" alt="{{ user.email }}" class="w-10 h-10 rounded-full object-cover border-2 border-blue-500/50">
            {% else %}
            <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 border border-gray-500">
                {{ user.first_name|slice:":1" }}{{ user.last_name|slice:":1" }}
            </div>
            {% endif %}
            
            <div class="flex flex-col">
                <span class="text-sm font-semibold text-gray-100">{{ user.first_name }} {{ user.last_name }}</span>
                <span class="text-xs text-gray-400">{{ user.email }}</span>
            </div>
        </div>
        {% empty %}
        <div class="p-4 text-gray-400 text-sm">No conversations.</div>
        {% endfor %}
    </div>

    <!-- New Message List -->
    <div id="newMessageList" class="hidden flex-1 overflow-y-auto border-t border-gray-700/40">
        {% for user in all_users %}
            {% if user != request.user %}
            <div class="new-user-item flex items-center gap-3 p-3 border-b border-gray-700/40 hover:bg-white/10 cursor-pointer transition rounded-r-lg" data-user-id="{{ user.id }}">
                
                {% if user.profile_image.url %}
                <img src="{{ user.profile_image.url }}" alt="{{ user.email }}" class="w-10 h-10 rounded-full object-cover border-2 border-blue-500/50">
                {% else %}
                <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 border border-gray-500">
                    {{ user.first_name|slice:":1" }}{{ user.last_name|slice:":1" }}
                </div>
                {% endif %}
                
                <div class="flex flex-col">
                    <span class="text-sm font-semibold text-gray-100">{{ user.first_name }} {{ user.last_name }}</span>
                    <span class="text-xs text-gray-400">{{ user.email }}</span>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', () => {
    const newMsgBtn = document.getElementById('newMsgBtn');
    const userList = document.getElementById('userList');
    const newMessageList = document.getElementById('newMessageList');
    const chatWindow = document.getElementById('chatWindow');
    const chatUserName = document.getElementById('chatUserName');
    const chatMessages = document.getElementById('chatMessages');

    // --- Toggle New Messages list ---
    newMsgBtn.addEventListener('click', () => {
        if (newMessageList.classList.contains('hidden')) {
            newMessageList.classList.remove('hidden');
            userList.classList.add('hidden');
            newMsgBtn.textContent = 'Back';
        } else {
            newMessageList.classList.add('hidden');
            userList.classList.remove('hidden');
            newMsgBtn.textContent = 'New';
        }
    });

    // --- Funkcja do otwierania konwersacji ---
    function openConversation(userId, userName) {
        if (!userId) return;
        // Ustawiamy nagłówek chat
        chatUserName.textContent = userName;
        chatWindow.classList.remove('hidden');

        // Po kliknięciu wracamy do listy konwersacji
        newMessageList.classList.add('hidden');
        userList.classList.remove('hidden');
        newMsgBtn.textContent = 'New';

        // Ładujemy wiadomości AJAX-em
        fetch(`/messages/conversation_json/${userId}/`)
            .then(res => res.json())
            .then(data => {
                chatMessages.innerHTML = '';
                data.messages.forEach(msg => {
                    const isMine = msg.sender_id === {{ request.user.id }};
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `p-2 rounded-lg ${isMine ? 'bg-blue-500 text-white self-end' : 'bg-white/20 text-gray-100'} max-w-xs mb-1`;
                    msgDiv.textContent = msg.content;
                    chatMessages.appendChild(msgDiv);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
    }

    // --- Delegacja kliknięć w istniejącej liście ---
    userList.addEventListener('click', (e) => {
        const item = e.target.closest('.user-item');
        if (!item) return;
        const userId = item.getAttribute('data-user-id');
        const userName = item.querySelector('span').textContent.trim();
        openConversation(userId, userName);
    });

    // --- Delegacja kliknięć w nowej liście ---
    newMessageList.addEventListener('click', (e) => {
        const item = e.target.closest('.new-user-item');
        if (!item) return;
        const userId = item.getAttribute('data-user-id');
        const userName = item.querySelector('span').textContent.trim();
        openConversation(userId, userName);
    });
});
</script>



