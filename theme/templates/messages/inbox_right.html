<div id="messagesPanel"
     class="absolute right-0 top-0 w-1/5 bg-white h-screen shadow-2xl overflow-hidden flex flex-col hidden z-50">

    <div class="p-4 bg-blue-600 text-white flex justify-between items-center">
        <h2 class="text-xl font-semibold">Messages</h2>
        <button id="closeMessagesBtn" class="text-white text-2xl">&times;</button>
    </div>

    <div class="flex justify-between items-center p-4 border-b">
      <h3 class="font-semibold text-gray-700">Your Conversations</h3>
      <button id="newMsgBtn" class="text-blue-600 hover:underline text-sm">New</button>
    </div>

    <div id="userList" class="flex-1 overflow-y-auto">
      {% for user in users %}
          <div class="user-item p-4 border-b hover:bg-gray-100 cursor-pointer" data-user-id="{{ user.id }}">
              <div class="text-black">{{ user.email }}</div>
          </div>
      {% empty %}
          <div class="p-4 text-gray-500">No conversations.</div>
      {% endfor %}
    </div>

    <div id="newMessageList" class="hidden flex-1 overflow-y-auto border-t">
      {% for user in all_users %}
          {% if user != request.user %}
              <div class="new-user-item p-4 border-b hover:bg-gray-100 cursor-pointer" data-user-id="{{ user.id }}">
                  <div class="text-black">{{ user.email }}</div>
              </div>
          {% endif %}
      {% endfor %}
    </div>
</div>

<div id="chatWindow"
     class="absolute right-0 top-0 h-screen w-1/5 bg-gray-50 shadow-2xl hidden flex flex-col z-50">
    <div class="p-4 bg-blue-600 text-white flex justify-between items-center">
        <h2 id="chatUserName" class="text-lg font-semibold">Chat</h2>
        <button id="closeChatBtn" class="text-white text-2xl">&times;</button>
    </div>

    <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-2"></div>

    <div class="p-4 border-t bg-white">
        <form id="chatForm" class="flex">
            <input type="text" id="messageInput" class="flex-1 border rounded-l px-3 py-2 text-black" placeholder="Write a message..." />
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-r">Send</button>
        </form>
    </div>
</div>

<script>
    const openBtn = document.getElementById('openMessagesBtn');
    const closeBtn = document.getElementById('closeMessagesBtn');
    const panel = document.getElementById('messagesPanel');
    const chatWindow = document.getElementById('chatWindow');
    const chatMessages = document.getElementById('chatMessages');
    const chatUserName = document.getElementById('chatUserName');
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const closeChatBtn = document.getElementById('closeChatBtn');

    let currentUserId = null;

    openBtn.addEventListener('click', () => {
        panel.classList.remove('hidden');
    });

    closeBtn.addEventListener('click', () => {
        panel.classList.add('hidden');
    });

    closeChatBtn.addEventListener('click', () => {
        chatWindow.classList.add('hidden');
    });

    document.querySelectorAll('.user-item').forEach(item => {
        item.addEventListener('click', () => {
            const userId = item.getAttribute('data-user-id');
            currentUserId = userId;
            chatUserName.textContent = item.textContent.trim();
            chatWindow.classList.remove('hidden'); // show instead of sliding
            loadMessages(userId);
        });
    });

    // Load messages (AJAX GET)
    function loadMessages(userId) {
        fetch(`/messages/conversation_json/${userId}/`)
            .then(res => res.json())
            .then(data => {
                chatMessages.innerHTML = '';
                data.messages.forEach(msg => {
                    const isMine = msg.sender_id === {{ request.user.id }};
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `p-2 rounded-lg ${isMine ? 'bg-blue-500 text-white self-end' : 'bg-gray-200'} max-w-xs`;
                    msgDiv.textContent = msg.content;
                    chatMessages.appendChild(msgDiv);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
    }

    // Send message (AJAX POST)
    chatForm.addEventListener('submit', e => {
        e.preventDefault();
        const content = messageInput.value.trim();
        if (!content || !currentUserId) return;

        fetch(`/messages/conversation_json/${currentUserId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ content })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                messageInput.value = '';
                loadMessages(currentUserId);
            }
        });
    });

    // Refresh every 3 seconds (optional)
    // setInterval(() => {
    //     if (currentUserId) loadMessages(currentUserId);
    // }, 3000);

    const newMsgBtn = document.getElementById('newMsgBtn');
    const newMessageList = document.getElementById('newMessageList');
    const userList = document.getElementById('userList');

    newMsgBtn.addEventListener('click', () => {
        if (newMessageList.classList.contains('hidden')) {
            newMessageList.classList.remove('hidden');
            userList.classList.add('hidden');
            newMsgBtn.textContent = 'Back';
        } else {
            newMessageList.classList.add('hidden');
            userList.classList.remove('hidden');
            newMsgBtn.textContent = 'New';
        }
    });

    document.querySelectorAll('.new-user-item').forEach(item => {
        item.addEventListener('click', () => {
            const userId = item.getAttribute('data-user-id');
            currentUserId = userId;
            chatUserName.textContent = item.textContent.trim();
            chatWindow.classList.remove('hidden');
            loadMessages(userId);
            // switch back to conversation list
            newMessageList.classList.add('hidden');
            userList.classList.remove('hidden');
            newMsgBtn.textContent = 'New';
        });
    });
</script>
