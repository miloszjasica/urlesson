{% load static tailwind_tags %}

<nav class="sticky top-0 z-50 bg-black backdrop-blur-xl border-b border-gray-700 shadow-md bg-opacity-50">
  <div class="flex items-center justify-between py-4 px-6 md:px-32">

    <div class="flex items-center gap-6">
      <a href="/" class="text-3xl font-bold text-white tracking-tight hover:text-blue-400 transition mr-8">
        UrLesson
      </a>

      {% if user.is_student %}
        <a href="{% url 'teacher_list' %}" class="text-gray-300 hover:text-white transition">Teachers</a>
        <a href="{% url 'student_calendar' %}" class="text-gray-300 hover:text-white transition">Calendar</a>
      {% endif %}
      {% if user.is_teacher %}
        <a href="{% url 'teacher_availability' %}" class="text-gray-300 hover:text-white transition">My Lessons</a>
      {% endif %}
    </div>

    <div class="flex items-center gap-6 text-white">

      {% if user.is_authenticated %}
        <div class="relative">
          <button id="notifications-button" class="relative p-2 rounded-full hover:bg-gray-800 transition">
            <span id="bell-icon" class="material-symbols-outlined text-2xl">notifications</span>
            <span id="notifications-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1 hidden"></span>
          </button>

          <div id="notifications-dropdown" class="hidden absolute right-0 mt-2 w-64 bg-gray-800 text-white rounded-lg shadow-lg overflow-hidden border border-gray-700 z-50"></div>
        </div>

        <div class="relative">
          <button id="profileBtn" class="relative flex items-center justify-center rounded-full overflow-hidden w-12 h-12 border-2 border-gray-600 bg-gray-800 hover:border-blue-400 transition">
            {% if user.avatar %}
              <img src="{{ user.avatar.url }}" alt="Profile" class="w-full h-full object-cover">
            {% else %}
              <span class="text-lg font-semibold text-white">
                {{ request.user.first_name|default:request.user.username|slice:":1" }}{{ request.user.last_name|slice:":1" }}
              </span>
            {% endif %}
          </button>

          <div id="profileDropdown" class="hidden absolute right-0 mt-3 w-48 bg-white text-black rounded-lg shadow-lg border border-gray-200 z-50">
            <a href="{% url 'profile' %}" class="block px-4 py-2 hover:bg-gray-100">Profile</a>
            <form action="{% url 'accounts:logout' %}" method="post">
              {% csrf_token %}
              <button type="submit" class="w-full text-left px-4 py-2 hover:bg-gray-100">Logout</button>
            </form>
          </div>
        </div>

      {% else %}
        <a href="{% url 'accounts:login' %}" class="bg-blue-600 hover:bg-blue-700 text-white text-lg px-5 py-2 rounded-full transition">
          Login
        </a>
        {% if request.path != '/' %}
          <a href="{% url 'accounts:register' %}" class="bg-green-600 hover:bg-green-700 text-white text-lg px-5 py-2 rounded-full transition">
            Register
          </a>
        {% endif %}
      {% endif %}
    </div>
  </div>
</nav>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const notificationsBtn = document.getElementById('notifications-button');
  const notificationsDropdown = document.getElementById('notifications-dropdown');
  const notificationsCount = document.getElementById('notifications-count');

  const profileBtn = document.getElementById('profileBtn');
  const profileDropdown = document.getElementById('profileDropdown');


  async function loadNotifications() {
    try {
      const res = await fetch("{% url 'notifications_json' %}");
      const data = await res.json();

      notificationsDropdown.innerHTML = data.map(n => `
        <div class="px-4 py-2 hover:bg-gray-700 border-b border-gray-700">
          ${n.message}
        </div>
      `).join("");

      const unread = data.filter(n => !n.read).length;
      if (unread > 0) {
        notificationsCount.textContent = unread;
        notificationsCount.classList.remove("hidden");
      } else {
        notificationsCount.classList.add("hidden");
      }
    } catch (err) {
      console.error(err);
    }
  }

  notificationsBtn?.addEventListener('click', (e) => {
    e.stopPropagation();

    notificationsDropdown.classList.toggle('hidden');
    profileDropdown?.classList.add('hidden');

    if (!notificationsDropdown.classList.contains('hidden')) {
      notificationsCount.classList.add('hidden');

      fetch("{% url 'mark_notifications_read' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "Content-Type": "application/json"
        },
      });
    }
  });

  notificationsDropdown?.addEventListener('click', (e) => {
    e.stopPropagation();
  });

  profileBtn?.addEventListener('click', (e) => {
    e.stopPropagation();

    profileDropdown.classList.toggle('hidden');
    notificationsDropdown?.classList.add('hidden');
  });

  profileDropdown?.addEventListener('click', (e) => {
    e.stopPropagation();
  });

  document.addEventListener('click', () => {
    notificationsDropdown?.classList.add('hidden');
    profileDropdown?.classList.add('hidden');
  });

  loadNotifications();
</script>

