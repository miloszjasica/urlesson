{% load static tailwind_tags %}

<nav class="border-gray-800">
  <div class="flex items-center bg-gray-800 justify-between py-4 border-b border-gray-500 px-32">
    <div class="flex">
      <div class="text-lg flex">
        <a href="/"><img src="{% static 'urlesson.png' %}" class="w-64 h-[auto] -mb-16 -mt-8" alt="urlesson"></a>
      </div>
      {% if user.is_student %}
        <a href="{% url 'teacher_list' %}" class="hover:underline ml-8 px-4 py-8 text-3xl underline">Teachers</a>
      {% endif %}
      {% if user.is_student %}
      <a href="{% url 'student_calendar' %}" class="hover:underline ml-2 px-4 py-8 text-3xl underline">Calendar</a>
      {% endif %}
      {% if user.is_teacher %}
      <a href="{% url 'teacher_availability' %}" class="hover:underline ml-2 px-4 py-8 text-3xl underline">My Lessons</a>
      {% endif %}
    </div>
    <div class="flex text-2xl gap-4">
      {% if user.is_authenticated %}
        <div class="relative">
          <button id="notifications-button" class="relative py-2">
            <span id="bell-icon" class="material-symbols-outlined text-3xl">notifications</span>
            <span id="notifications-count" class="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full"></span>
          </button>
          <div id="notifications-dropdown" class="hidden absolute right-0 mt-2 w-64 bg-gray-800 text-white rounded shadow-lg z-50"></div>
        </div>
        <button id="openMessagesBtn" class="relative flex items-center justify-center px-8 rounded-full hover:bg-gray-800 transition">
            <span class="material-symbols-outlined text-white text-3xl">
                chat
            </span>
            <span id="chat-unread-badge"
                  class="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full px-1 hidden">
            </span>
        </button>


        <a href="{% url 'profile' %}" class="bg-green-500 text-black hover:bg-blue-500 text-3xl px-4 py-2 border-black rounded">My Profile</a>
        <form action="{% url 'accounts:logout' %}" method="post" class="inline">
            {% csrf_token %}
            <button type="submit" class="bg-yellow-500 hover:bg-red-500 text-black text-3xl px-4 py-2 border-black rounded">
                Logout
            </button>
        </form>
      {% else %}
      <a href="{% url 'accounts:login' %}" class="bg-green-500 text-black hover:bg-blue-500 text-3xl px-4 py-2 border-black rounded">Login</a>
      {% if request.path != '/'%}
        <a href="{% url 'accounts:register' %}" class="bg-yellow-500 text-black text-3xl hover:bg-red-500 px-4 py-2 border-black rounded">Register</a>
      {% endif %}
      {% endif %}
    </div>
  </div>
</nav>
<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.startsWith(name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

const button = document.getElementById('notifications-button');
const dropdown = document.getElementById('notifications-dropdown');
const countSpan = document.getElementById('notifications-count');

async function loadNotifications() {
  try {
    const res = await fetch("{% url 'notifications_json' %}");
    const data = await res.json();

    dropdown.innerHTML = data.map(n => `
      <div class="px-4 py-2 hover:bg-gray-700 border-b border-gray-600">
        ${n.message}
      </div>
    `).join("");

    const unreadCount = data.filter(n => !n.read).length;
    countSpan.textContent = unreadCount;
    countSpan.style.display = unreadCount ? "inline-block" : "none";

  } catch (err) {
    console.error("Error:", err);
  }
}

button.addEventListener('click', () => {
  dropdown.classList.toggle('hidden');

  if (!dropdown.classList.contains('hidden')) {
    countSpan.textContent = 0;
    countSpan.style.display = 'none';

    fetch("{% url 'mark_notifications_read' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
        "Content-Type": "application/json"
      },
    })
    .then(res => res.json())
  }
});

//setInterval(loadNotifications, 10000);
loadNotifications();
</script>