{% extends 'base.html' %}
{% block content %}
<div class="px-32 py-8 bg-gradient-to-b from-gray-900 via-gray-700 to-gray-900">
  <div class="mb-8 border-b border-gray-600">
    <p class="flex text-5xl font-bold mb-4 justify-center">My Lessons</p>
  </div>
  <div id="calendar"></div>
</div>

<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet'/>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>

<div id="lesson-action-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-gray-700 p-6 w-[400px] rounded-lg shadow-lg flex flex-col">
    <h2 class="text-2xl font-bold mb-4 text-white" id="modal-title">Lesson Action</h2>
    <p id="modal-info" class="mb-6 text-gray-300"></p>

    <div class="flex justify-center space-x-4">
      <button id="cancel" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Cancel Lesson</button>
      <button id="close-modal" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">Close</button>
    </div>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {
  const calendarEl = document.getElementById('calendar');
  const csrftoken = "{{ csrf_token }}";
  const modal = document.getElementById('lesson-action-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalInfo = document.getElementById('modal-info');
  const closeModalBtn = document.getElementById('close-modal');
  const cancelBtn = document.getElementById('cancel');
  let currentLessonId = null;

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',
    allDaySlot: false,
    height: 'auto',
    scrollTime: '08:00:00',
    slotMinTime: '06:00:00',
    slotMaxTime: '22:00:00',
    timeZone: 'UTC',
    headerToolbar: {
      right: 'prev,next',
      center: 'title',
      left: 'today'
    },
    events: "{% url 'student_calendar_json' %}",

    eventClick: function (info) {
      const type = info.event.extendedProps.type;
      const status = info.event.extendedProps.status;
      
      currentLessonId = info.event.id.replace("lesson-", "");

      if (type === "lesson" && status === "pending") {
        modalTitle.textContent = "Cancel Pending Lesson";
        modalInfo.textContent = `Do you want to cancel your pending lesson ${info.event.title}?`;
        modal.classList.remove('hidden');
      } else {
        modalTitle.textContent = "Lesson Info";
        modalInfo.textContent = "You cannot cancel this lesson because itâ€™s already accepted.";
        cancelBtn.classList.add("hidden");
        modal.classList.remove('hidden');
      }

    }
  });

  calendar.render();

  function renderNowIndicator() {

  document.querySelectorAll('.fc-now-indicator').forEach(el => el.remove());

  const now = new Date();
  const calendarEl = calendarElRef.querySelector('.fc-timeGridWeek-view, .fc-timeGridDay-view');

  if (!calendarEl) return;

  const dayColumn = calendarEl.querySelector(
    `.fc-daygrid-day[data-date="${now.toISOString().split('T')[0]}"], 
     .fc-timegrid-col[data-date="${now.toISOString().split('T')[0]}"]`
  );

  if (!dayColumn) return;

  const timeGrid = calendarEl.querySelector('.fc-timegrid-slots');
  const startHour = 6;
  const pixelsPerHour = timeGrid.offsetHeight / (22 - startHour);
  const topOffset = ((now.getHours() + now.getMinutes() / 60) - startHour) * pixelsPerHour;

  const line = document.createElement('div');
  line.classList.add('fc-now-indicator');
  line.style.position = 'absolute';
  line.style.top = `${topOffset}px`;
  line.style.left = '0';
  line.style.right = '0';
  line.style.height = '2px';
  line.style.background = 'red';
  line.style.zIndex = '9999';
  line.style.boxShadow = '0 0 6px rgba(255,0,0,0.6)';
  line.style.transition = 'top 0.5s linear';

  dayColumn.appendChild(line);
}

const calendarElRef = document.getElementById('calendar');

renderNowIndicator();
setInterval(renderNowIndicator, 300000);

  closeModalBtn.addEventListener('click', () => {
    modal.classList.add('hidden');
    cancelBtn.classList.remove("hidden");
  });

  cancelBtn.addEventListener('click', () => {
    if (!currentLessonId) return;
    fetch("{% url 'update_lesson_status_student' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken
      },
      body: JSON.stringify({
        id: currentLessonId,
        action: "cancel"
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        modal.classList.add('hidden');
        cancelBtn.classList.remove("hidden");
        calendar.refetchEvents();
        showToast("Lesson cancelled successfully.", "bg-green-600");
      } else {
        showToast("Could not cancel this lesson.", "bg-red-600");
      }
    });
  });
});
</script>


{% endblock %}
