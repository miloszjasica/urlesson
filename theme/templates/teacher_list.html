{% extends "base.html" %}
{% load static %}
{% block title %}List of Teachers{% endblock %}

{% block content %}
<div class="text-white py-16 px-8 md:px-32">
    <div class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
    <form method="get" class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
        <input type="text" name="q" placeholder="Search by name" value="{{ request.GET.q|default_if_none:'' }}"
               class="px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-400">
        <select name="subject" class="px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-400">
            <option value="">All subjects</option>
            {% for subj in subjects %}
            <option value="{{ subj.id }}" {% if request.GET.subject == subj.id|stringformat:"s" %}selected{% endif %}>{{ subj.name }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="px-4 py-2 bg-blue-500 rounded-lg text-white hover:bg-blue-600 transition">Filter</button>
    </form>
</div>
    
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
        {% for user in object_list %}
        <div class="relative bg-gray-800 rounded-3xl shadow-2xl overflow-hidden transform transition-all hover:shadow-gray-500/50 p-6 flex flex-col items-start">
            

            <div class="flex items-center mb-4 w-full">
                {% if user.avatar %}
                <img src="{{ user.avatar.url }}" alt="{{ user.email }}" class="w-20 h-20 rounded-full object-cover border-2 border-blue-500">
                {% else %}
                <div class="w-20 h-20 rounded-full bg-gray-600 flex items-center justify-center text-gray-400 border-2 border-gray-400">
                    {{ user.first_name|slice:":1" }}{{ user.last_name|slice:":1" }}
                </div>
                {% endif %}

                <div class="ml-4 flex-1">
                    <h3 class="text-2xl font-bold">{{ user.first_name }} {{ user.last_name }}</h3>
                    <p class="text-sm text-gray-300 mt-1">
                        {% for subject in user.teacher_profile.subjects.all %}
                        <span class="inline-block px-2 py-1 mr-1 mb-1 bg-gray-700 rounded">{{ subject.name }}</span>
                        {% empty %}
                        No subjects assigned.
                        {% endfor %}
                    </p>
                </div>
            </div>


            {% if user.role == 'teacher' %}
                {% if request.user.is_authenticated %}
                <a href="{% url 'book_lesson' user.id %}" class="w-full text-center py-2 px-4 bg-green-500 rounded-xl font-semibold text-white mb-2 hover:bg-green-600 transition">
                    Book Lesson
                </a>
                <a href="#"
                    class="w-full text-center py-2 px-4 bg-blue-500 rounded-xl font-semibold text-white hover:bg-blue-600 transition view-details-btn"
                    data-teacher-id="{{ user.id }}">
                    View Details
                </a>

                {% else %}
                <a href="{% url 'accounts:login' %}" class="w-full text-center py-2 px-4 bg-blue-500 rounded-xl font-semibold text-white hover:bg-blue-600 transition">
                    Log In for More Options
                </a>
                {% endif %}
            {% endif %}
        </div>
        {% empty %}
        <p class="text-center text-gray-400 text-2xl col-span-full mt-16">No teachers found.</p>
        {% endfor %}
    </div>
</div>

<!-- MODAL -->
<div id="teacherModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
  <div class="bg-gray-900 rounded-3xl w-11/12 md:w-2/3 lg:w-1/2 p-8 relative">

    <button id="modalCloseBtn" class="absolute top-4 right-4 text-white text-3xl hover:text-red-500">&times;</button>

    <div class="flex flex-col md:flex-row gap-6">
      <!-- Avatar -->
    <div id="modalAvatarWrapper" class="w-40 h-40 md:w-48 md:h-48 rounded-full border-4 border-blue-500 flex items-center justify-center overflow-hidden flex-shrink-0 bg-gray-600 text-white text-4xl font-bold">
        <img id="modalAvatar" src="" alt="Avatar" class="w-full h-full object-cover hidden">
        <span id="modalInitials"></span>
    </div>



      <!-- Info -->
      <div class="flex-1 text-white space-y-3">
        <h2 id="modalName" class="text-3xl font-bold"></h2>
        <p id="modalSubjects" class="flex flex-wrap gap-2 text-gray-300"></p>
        <p id="modalTitleAge" class="text-gray-300"></p>
        <p id="modalPrice" class="text-gray-300"></p>
        <p id="modalExtra" class="text-gray-300"></p>
        <p id="modalDiscount" class="text-gray-300"></p>
        <p id="modalEmail" class="text-gray-300"></p>

        <!-- BOOK LESSON BUTTON -->
        <a id="modalBookBtn" href="#" class="block w-full text-center py-2 px-4 bg-green-500 rounded-xl font-semibold text-white hover:bg-green-600 transition">
          Book Lesson
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  const modal = document.getElementById('teacherModal');
  const closeBtn = document.getElementById('modalCloseBtn');
  const modalBookBtn = document.getElementById('modalBookBtn');

  // Pola w modalu
  const modalAvatar = document.getElementById('modalAvatar');
  const modalName = document.getElementById('modalName');
  const modalSubjects = document.getElementById('modalSubjects');
  const modalTitleAge = document.getElementById('modalTitleAge');
  const modalPrice = document.getElementById('modalPrice');
  const modalExtra = document.getElementById('modalExtra');
  const modalDiscount = document.getElementById('modalDiscount');
  const modalEmail = document.getElementById('modalEmail');

  function calculateAge(dob) {
    if (!dob) return 'N/A';
    const birthDate = new Date(dob);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
    return age;
  }

  function getTitle(gender) {
    if (gender === 'male') return 'Mr.';
    if (gender === 'female') return 'Ms.';
    return '';
  }

  document.querySelectorAll('.view-details-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const teacherId = btn.dataset.teacherId;

      const res = await fetch("{% url 'accounts:teacher_json' 0 %}".replace('/0/', `/${teacherId}/`));
      const data = await res.json();

      const title = getTitle(data.gender);
      modalAvatar.src = data.avatar || "{% static 'default-avatar.png' %}";
      modalName.textContent = `${title} ${data.name}`;

      if (data.avatar) {
        modalAvatar.src = data.avatar;
        modalAvatar.classList.remove('hidden');
        document.getElementById('modalInitials').textContent = '';
        } else {
        modalAvatar.classList.add('hidden');
        document.getElementById('modalInitials').textContent = data.name.split(' ').map(n => n[0]).join('');
        }


      const age = calculateAge(data.date_of_birth);
      modalTitleAge.textContent = `Age: ${age} yo`;
      modalSubjects.innerHTML = data.subjects.map(s => `<span class="px-2 py-1 bg-gray-700 rounded">${s}</span>`).join('');

      const indPriceHour = data.price_per_minute_individual ? (parseFloat(data.price_per_minute_individual) * 60).toFixed(2) : '-';
      const grpPriceHour = data.price_per_minute_group ? (parseFloat(data.price_per_minute_group) * 60).toFixed(2) : '-';
      modalPrice.textContent = `Individual: ${indPriceHour} zÅ‚/h`;
      modalDiscount.textContent = `Recurring discount: ${data.recurring_discount_percent || 0}%`;
      modalEmail.textContent = `Contact: ${data.email || 'N/A'}`;

      modalBookBtn.href = "{% url 'book_lesson' 0 %}".replace('/0/', `/${teacherId}/`);

      modal.classList.remove('hidden');
    });
  });

  closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
  modal.addEventListener('click', e => {
    if (e.target === modal) modal.classList.add('hidden');
  });
</script>

{% endblock %}
